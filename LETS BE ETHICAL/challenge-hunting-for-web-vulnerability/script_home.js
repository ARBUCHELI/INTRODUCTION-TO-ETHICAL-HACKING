const usernameErrorOutput = document.getElementById("usernameError");
const passwordErrorOutput = document.getElementById("passwordError");

const errorOut = (usernameError, passwordError) => {
  if(usernameError !== undefined) {
    const errorMessage = usernameErrorOutput;
    errorMessage.style.display = "";
    errorMessage.innerText = usernameError;
  }
  if(passwordError) {
    const errorMessage = passwordErrorOutput;
    errorMessage.style.display = "";
    errorMessage.innerText = passwordError;
  }
}

const loadUser = (user) => {
  console.log("Loading user: " + user.username);
  window.name = JSON.stringify(user);
  window.location.href="user.html"
}

document.getElementById("formElem").onsubmit = async (e) => {
  e.preventDefault();

  //Refresh error messages
  usernameErrorOutput.style.display = passwordErrorOutput.style.display = "none";

  //Get input data
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  //Check for SQL injection
  if(settings.allowSqlInjection) {
    if(password == settings.injectionString) {
      document.getElementById("injectionOutput").innerText = JSON.stringify(settings.users);
      return;
    }
  }

  //Make sure entry was provided (normal behavior)
  if(username.length <= 0) {
    errorOut("Please provide an email", undefined);
    return;
  }
  else if(password.length <= 0) {
    errorOut(undefined, "Please provide a password");
    return;
  }

  //Check that username is an email
  if(!(username.includes("@") && username.includes("."))) {
    errorOut("Please insert an email address.", undefined);
    return;
  }

  //Scan user database for matching username
  let foundUsername = false;
  for(let i = 0; i < settings.users.length; i++) {
    const user = settings.users[i];

    if(user.username == username) {
      foundUsername = true;

      if(user.password == password) {
        loadUser(user);
        return;
      }

      else {
        errorOut(undefined, "This is not the correct password for this account.")
        break;
      }
    }
  }
  if(!foundUsername) errorOut("There's no account with this email address.", "The password is invalid.");

};